<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Grandmaster Elite | Pro Edition</title>
  <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
  <style>
    :root {
      --bg-color: #0f0f0f;
      --accent: #d4a373;
      --light-sq: #f0d9b5;
      --dark-sq: #b58863;
      --highlight: rgba(255, 235, 59, 0.4);
      --hint: rgba(0, 0, 0, 0.15);
      --sq-size: clamp(40px, 8vh, 65px); 
    }

    * { box-sizing: border-box; }
    body, html { margin: 0; padding: 0; width: 100%; height: 100%; background: var(--bg-color); color: #fff; font-family: 'Segoe UI', sans-serif; overflow: hidden; }

    .app-container { display: flex; flex-direction: column; width: 100vw; height: 100vh; padding: 1vh; align-items: center; }

    .control-center {
      background: #1a1a1a;
      padding: 15px;
      border-radius: 12px;
      margin-bottom: 10px;
      display: flex;
      flex-direction: column;
      gap: 12px;
      border: 1px solid #333;
      width: 100%;
      max-width: 650px;
    }

    .mode-selector { display: flex; justify-content: center; gap: 10px; }
    .mode-btn { background: #333; color: #fff; border: 1px solid #444; padding: 8px 16px; border-radius: 6px; cursor: pointer; transition: 0.3s; font-size: 0.85rem; }
    .mode-btn.active { background: var(--accent); color: #000; font-weight: bold; border-color: var(--accent); }

    .connection-panel { display: none; justify-content: center; gap: 8px; align-items: center; background: #222; padding: 10px; border-radius: 8px; border: 1px solid #444; }

    #status { font-size: 1rem; color: var(--accent); margin: 10px 0; text-transform: uppercase; letter-spacing: 2px; height: 1.5rem; }

    .board-wrapper { border: 10px solid #2c1e12; border-radius: 4px; box-shadow: 0 20px 50px rgba(0,0,0,0.7); }
    #chessboard { display: grid; grid-template-columns: repeat(8, var(--sq-size)); grid-template-rows: repeat(8, var(--sq-size)); }
    
    .square { width: var(--sq-size); height: var(--sq-size); display: flex; align-items: center; justify-content: center; cursor: pointer; }
    .light { background-color: var(--light-sq); }
    .dark { background-color: var(--dark-sq); }
    .selected { background-color: var(--highlight) !important; }
    .move-hint::after { content: ""; width: 25%; height: 25%; background: var(--hint); border-radius: 50%; }

    .piece { font-size: calc(var(--sq-size) * 0.85); user-select: none; z-index: 10; transition: transform 0.2s; }
    .piece.white { color: #fff; text-shadow: 0 2px 4px rgba(0,0,0,0.5); }
    .piece.black { color: #000; }

    input { background: #000; border: 1px solid #444; color: #fff; padding: 6px; border-radius: 4px; width: 140px; font-size: 0.8rem; }
    .id-text { font-family: monospace; color: #aaa; font-size: 0.75rem; background: #111; padding: 4px 8px; border-radius: 4px; }
  </style>
</head>
<body>

<div class="app-container">
  <div class="control-center">
    <div class="mode-selector">
      <button id="btn-local" class="mode-btn active" onclick="setMode('local')">Local Play</button>
      <button id="btn-ai" class="mode-btn" onclick="setMode('ai')">VS Computer</button>
      <button id="btn-peer" class="mode-btn" onclick="setMode('peer')">Invite Friend</button>
    </div>
    
    <div id="peer-panel" class="connection-panel">
      <span id="peer-id-label" class="id-text">ID: Loading...</span>
      <button class="mode-btn" style="padding:4px 8px" onclick="copyMyID()">Copy ID</button>
      <div style="border-left: 1px solid #444; height: 20px; margin: 0 5px;"></div>
      <input type="text" id="join-id" placeholder="Paste Friend's ID">
      <button class="mode-btn" style="padding:4px 8px" onclick="joinFriend()">Connect</button>
    </div>
  </div>

  <div id="status">White to Move</div>

  <div class="board-wrapper">
    <div id="chessboard"></div>
  </div>
</div>

<script>
  // --- SETTINGS ---
  let gameMode = 'local';
  let myColor = null; // Used for Online Friend
  let peer, conn;
  let isAIBusy = false;

  const piecesMap = { r:"♜", n:"♞", b:"♝", q:"♛", k:"♚", p:"♟", R:"♖", N:"♘", B:"♗", Q:"♕", K:"♔", P:"♙" };
  const visualMap = { "♖":"♜", "♘":"♞", "♗":"♝", "♕":"♛", "♔":"♚", "♙":"♟", "♜":"♜", "♞":"♞", "♝":"♝", "♛":"♛", "♚":"♚", "♟":"♟" };
  
  let gameState = { squares: new Array(64).fill(""), currentTurn: "white", selectedIdx: null, gameActive: true };

  // --- INIT ---
  function initBoard() {
    const start = ["rnbqkbnr", "pppppppp", "........", "........", "........", "........", "PPPPPPPP", "RNBQKBNR"];
    gameState.squares = new Array(64).fill("");
    start.forEach((row, r) => [...row].forEach((char, c) => {
        if (char !== ".") gameState.squares[r * 8 + c] = piecesMap[char];
    }));
    gameState.currentTurn = "white";
    gameState.gameActive = true;
    gameState.selectedIdx = null;
    isAIBusy = false;
    createUI();
    updateDisplay();
  }

  function createUI() {
    const board = document.getElementById("chessboard");
    board.innerHTML = "";
    for (let i = 0; i < 64; i++) {
      const sq = document.createElement("div");
      sq.className = `square ${ (Math.floor(i/8) + (i%8)) % 2 === 0 ? 'light' : 'dark' }`;
      sq.onclick = () => onSquareClick(i);
      board.appendChild(sq);
    }
  }

  function updateDisplay() {
    const squares = document.getElementById("chessboard").children;
    for (let i = 0; i < 64; i++) {
      const sq = squares[i]; sq.innerHTML = ""; sq.classList.remove("selected", "move-hint");
      const p = gameState.squares[i];
      if (p) {
        const span = document.createElement("span");
        const color = ["♙","♖","♘","♗","♕","♔"].includes(p) ? "white" : "black";
        span.className = `piece ${color}`;
        span.textContent = visualMap[p];
        sq.appendChild(span);
      }
      if (gameState.selectedIdx === i) sq.classList.add("selected");
      if (gameState.selectedIdx !== null && isLegalMove(gameState.selectedIdx, i)) sq.classList.add("move-hint");
    }

    // Status Message logic
    let statusMsg = `${gameState.currentTurn} to move`;
    if (gameMode === 'ai' && gameState.currentTurn === 'black') statusMsg = "Computer is thinking...";
    if (gameMode === 'peer' && myColor && gameState.currentTurn !== myColor) statusMsg = "Waiting for friend...";
    document.getElementById("status").innerText = statusMsg;
  }

  // --- CHESS LOGIC ---
  function getPieceColor(p) { return p ? (["♙","♖","♘","♗","♕","♔"].includes(p) ? "white" : "black") : null; }
  
  function isPathClear(f, t, s) {
    const fr = Math.floor(f/8), fc = f%8, tr = Math.floor(t/8), tc = t%8;
    const rs = tr === fr ? 0 : (tr > fr ? 1 : -1), cs = tc === fc ? 0 : (tc > fc ? 1 : -1);
    let r = fr + rs, c = fc + cs;
    while (r !== tr || c !== tc) { if (s[r * 8 + c] !== "") return false; r += rs; c += cs; }
    return true;
  }

  function isValidGeom(p, f, t, s) {
    const fr = Math.floor(f/8), fc = f%8, tr = Math.floor(t/8), tc = t%8;
    const rd = Math.abs(tr - fr), cd = Math.abs(tc - fc), target = s[t], color = getPieceColor(p), type = visualMap[p];
    if (target && getPieceColor(target) === color) return false;
    switch (type) {
      case "♜": return (fr === tr || fc === tc) && isPathClear(f, t, s);
      case "♝": return (rd === cd) && isPathClear(f, t, s);
      case "♛": return (fr === tr || fc === tc || rd === cd) && isPathClear(f, t, s);
      case "♞": return (rd === 2 && cd === 1) || (rd === 1 && cd === 2);
      case "♚": return rd <= 1 && cd <= 1;
      case "♟":
        if (color === "white") return (fc === tc && !target && (tr === fr-1 || (fr===6 && tr===4 && s[5*8+fc]===""))) || (cd===1 && tr===fr-1 && target && getPieceColor(target)==="black");
        else return (fc === tc && !target && (tr === fr+1 || (fr===1 && tr===3 && s[2*8+fc]===""))) || (cd===1 && tr===fr+1 && target && getPieceColor(target)==="white");
    }
  }

  function isLegalMove(f, t) {
    const s = gameState.squares;
    if (!isValidGeom(s[f], f, t, s)) return false;
    const v = [...s]; v[t] = v[f]; v[f] = "";
    const color = getPieceColor(s[f]), kIdx = v.indexOf(color === "white" ? "♔" : "♚"), opp = color === "white" ? "black" : "white";
    return !v.some((p, i) => p && getPieceColor(p) === opp && isValidGeom(p, i, kIdx, v));
  }

  // --- ACTIONS ---
  function onSquareClick(i) {
    if (!gameState.gameActive || isAIBusy) return;
    if (gameMode === 'ai' && gameState.currentTurn === 'black') return;
    if (gameMode === 'peer' && myColor && gameState.currentTurn !== myColor) return;

    const p = gameState.squares[i];
    if (gameState.selectedIdx === null) {
      if (p && getPieceColor(p) === gameState.currentTurn) gameState.selectedIdx = i;
    } else {
      if (isLegalMove(gameState.selectedIdx, i)) doMove(gameState.selectedIdx, i);
      else gameState.selectedIdx = (p && getPieceColor(p) === gameState.currentTurn) ? i : null;
    }
    updateDisplay();
  }

  function doMove(f, t, remote = false) {
    gameState.squares[t] = gameState.squares[f];
    gameState.squares[f] = "";
    if (!remote && gameMode === 'peer' && conn) conn.send({f, t});
    gameState.selectedIdx = null;
    gameState.currentTurn = gameState.currentTurn === "white" ? "black" : "white";
    updateDisplay();
    if (gameMode === 'ai' && gameState.currentTurn === 'black') runAI();
  }

  // --- AI ---
  function runAI() {
    isAIBusy = true;
    setTimeout(() => {
      const moves = [];
      gameState.squares.forEach((p, i) => {
        if (p && getPieceColor(p) === 'black') {
          for(let to=0; to<64; to++) if(isLegalMove(i, to)) moves.push({f:i, t:to});
        }
      });
      if (moves.length) {
        const m = moves[Math.floor(Math.random() * moves.length)];
        doMove(m.f, m.t, true);
      }
      isAIBusy = false;
      updateDisplay();
    }, 600);
  }

  // --- SYSTEM ---
  function setMode(m) {
    gameMode = m;
    document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('active'));
    document.getElementById('btn-' + m).classList.add('active');
    document.getElementById('peer-panel').style.display = (m === 'peer' ? 'flex' : 'none');
    if (m === 'peer' && !peer) initPeer();
    initBoard();
  }

  function initPeer() {
    peer = new Peer();
    peer.on('open', id => document.getElementById('peer-id-label').innerText = "ID: " + id);
    peer.on('connection', c => { conn = c; myColor = "white"; setupConn(); });
  }

  function copyMyID() {
    const id = document.getElementById('peer-id-label').innerText.split(': ')[1];
    if (id && id !== "Loading...") {
      navigator.clipboard.writeText(id);
      alert("ID copied! Send it to your friend.");
    }
  }

  function joinFriend() {
    const id = document.getElementById('join-id').value;
    if (id) { conn = peer.connect(id); myColor = "black"; setupConn(); }
  }

  function setupConn() {
    conn.on('open', () => { alert("Connected! You are playing as " + myColor); initBoard(); });
    conn.on('data', d => doMove(d.f, d.t, true));
  }

  window.onload = initBoard;
</script>
</body>
</html>
